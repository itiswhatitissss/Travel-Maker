<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>TravelMaker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/planDetail.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<!--header-->
<div th:insert="~{/travelmaker/main/header :: headerFragment}"></div>
<!--header-->

<nav>
    <th:block th:each="plan : ${planDTO}">
        <div id="nav_1">
            <div id="info">
                <h2>
                    [
                    <span th:text="${plan.title}"></span>
                    ]
                </h2>
                <p>
                    <span th:text="${plan.start}"></span>
                    ~
                    <span th:text="${plan.end}"></span>
                </p>
            </div>
        </div>
    </th:block>
</nav>

<div id="main">
    <aside>
        <h6>참가자 명단</h6>
        <ul th:each="attend: ${AttendDTO}">
            <li th:if="${attend.attender == 1}" >
                <span th:text="${attend.name}" th:style="${'color: green;'}"></span>
            </li>
            <li th:if="${attend.attender == 0}" >
                <span th:text="${attend.name}" th:style="${'color: red;'}"></span>
            </li>
        </ul>
        <div class="wrap" >
            <ul th:each="party: ${partyDTO}">
                <a th:href="@{'/travelmaker/main/list?pno=' + ${party.pno} + '&uno=' + ${uno}}" class="back-button">뒤로가기</a>
                <a href="#" class="button" data-bs-toggle="modal" data-bs-target="#myModal">참석투표</a>
                <a href="#" class="button2">button2</a>
                <a href="#" class="button">Button</a>
                <a href="#" class="button2">button2</a>
                <a href="#" class="button">Button</a>
                <a href="#" class="button2">button2</a>
            </ul>
        </div>

    </aside>

    <section>
        <div id="map" style="width:100%;height:800px;"></div>
        <input type="hidden" id="plno" th:value="${plnno}">
    </section>

    <!--    <section>-->
    <!--        <p>section2 부분입니다람쥐</p>-->
    <!--        <article>-->
    <!--            <p>article2 부분입니다람쥐</p>-->
    <!--        </article>-->
    <!--    </section>-->
</div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ee26f1fb7bd8c053dc49854ce7b2d099"></script>
<script>
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다


    // 마커를 추가하는 함수
    function addMarkerAndSaveToServer(position) {
        var marker = new kakao.maps.Marker({
            position: position
        });

        marker.setMap(map);

        // 생성된 마커의 좌표를 서버로 전송
        var lat = position.getLat();
        var lng = position.getLng();
        var plno = document.getElementById("plno").value;

        // AJAX 요청 보내기
        $.ajax({
            type: "POST",
            dataType: "json",
            url: "saveMarker", // 해당 URL은 실제 컨트롤러에서 처리할 URL로 변경해야 합니다.
            data: { lat: lat, lng: lng, plno: plno },
            success: function(response) {
                console.log("마커 좌표가 서버에 저장되었습니다.");
            },
            error: function(error) {
                console.error("마커 좌표 저장 중 오류가 발생했습니다.");
                console.log("Lat:", lat);
                console.log("Lng:", lng);
                console.log("Plno:", plno);
            }
        });
    }

    // 클릭 이벤트 리스너 등록
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        // 클릭한 위치에 마커를 추가하고 좌표를 서버로 전송
        addMarkerAndSaveToServer(mouseEvent.latLng);
    });

</script>
<script src="/js/index.js"></script>
<script src="/js/planDetail.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>


<!----참가 모달----->
<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">참석 투표</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div th:if="${att == 0}">
                    <form method="post" th:action="@{/travelmaker/plan/attend}" >
                        <input type="hidden" th:value="${plnno}" name="plno">
                        <input type="hidden" th:value="${ppno}" name="pno">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="attendance" th:value="1">
                            <label class="form-check-label">참석</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="attendance" th:value="0">
                            <label class="form-check-label">불참</label>
                        </div>
                        <button type="submit" class="btn btn-secondary" data-bs-dismiss="modal">투표하기</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </form>
                </div>
                <div th:if="${att == 1}">
                    <form method="post" th:action="@{/travelmaker/plan/modifyattend}" >
                        <input type="hidden" th:value="${plnno}" name="plno">
                        <input type="hidden" th:value="${ppno}" name="pno">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="attendance" th:value="1" th:checked="${attendCheck == 1}">
                            <label class="form-check-label">참석</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="attendance" th:value="0" th:checked="${attendCheck == 0}">
                            <label class="form-check-label">불참</label>
                        </div>
                        <button type="submit" class="btn btn-secondary" data-bs-dismiss="modal">투표하기</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
<!----참가 모달 끝----->
<!----참가 모달 스크립트----->
    <script>
        // "참석" 체크박스를 선택하면 "불참" 체크박스 선택 해제
        document.querySelector('input[name="attendance"][value="1"]').addEventListener('change', function() {
        if (this.checked) {
        document.querySelector('input[name="attendance"][value="0"]').checked = false;
        }
    });

        // "불참" 체크박스를 선택하면 "참석" 체크박스 선택 해제
        document.querySelector('input[name="attendance"][value="0"]').addEventListener('change', function() {
        if (this.checked) {
        document.querySelector('input[name="attendance"][value="1"]').checked = false;
    }
    });
    </script>
<!----참가 모달 스크립트  끝----->
</body>
</html>